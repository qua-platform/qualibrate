name: Publish to Private PyPI

on:
  workflow_dispatch:
    inputs:
      versionString:
        required: true
        type: string
        description: 'Package version string to use for the package. Should be in PEP 440 format.'

permissions:
  id-token: write
  contents: write
  checks: write

jobs:
  package-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Init and prints
        id: init
        run: |
          set -xe
          echo "Branch Name: ${GITHUB_REF#refs/heads/}" | tee -a $GITHUB_STEP_SUMMARY
          echo "Commit Hash: $(git rev-parse --short HEAD)" | tee -a $GITHUB_STEP_SUMMARY
          # Workaround for Generate build number cant handle + in version string
          echo "buildNumberString=$(echo ${{ github.event.inputs.versionString }} | sed 's/+/_/g')" >> $GITHUB_OUTPUT

      - name: Set version
        run: |
          set -xe
          VERSION=${{ github.event.inputs.versionString }}
          if [[ "$VERSION" =~ ^([0-9]+\.[0-9]+\.[0-9]+)([a-zA-Z0-9.-]*)$ ]]; then
            echo "BASE_VERSION=${BASH_REMATCH[1]}" >> $GITHUB_ENV
            echo "VERSION_SUFFIX=${BASH_REMATCH[2]}" >> $GITHUB_ENV
          else
            echo "BASE_VERSION=$VERSION" >> $GITHUB_ENV
            echo "VERSION_SUFFIX=" >> $GITHUB_ENV
          fi
          echo "FULL_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Setup Poetry
        run: |
          set -xe
          python -m pip install --upgrade pip
          python -m pip install --upgrade virtualenv
          pip install poetry==2.1.3
          pip install poetry-dynamic-versioning

      - name: Configure internal PyPI
        uses: ./.github/actions/configure-internal-pypi
        with:
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}

      - name: Poetry install
        run: poetry install

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: src/frontend/package-lock.json

      - name: Install frontend dependencies
        run: cd src/frontend && npm ci

      - name: Build frontend
        run: cd src/frontend && npm run build

      - name: Copy static files to package
        run: |
          mkdir -p src/qualibrate/app/qualibrate_static
          cp -r src/frontend/dist/* src/qualibrate/app/qualibrate_static/

      - name: Update package version
        run: |
          set -xe
          # Update pyproject.toml with the version
          sed -i "s/^version = .*/version = \"${{ env.FULL_VERSION }}\"/" pyproject.toml
          poetry version | sed 's/qualibrate/Version:/g' | tee -a $GITHUB_STEP_SUMMARY

      - name: Build and publish to private PyPI
        run: |
          set -xe
          poetry build
          poetry publish -r qm-pypi

      - name: Create and push tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git tag -a "iv${{ env.FULL_VERSION }}" -m "Internal release ${{ env.FULL_VERSION }}"
          git push origin "iv${{ env.FULL_VERSION }}"
