name: Publish to Private PyPI

on:
  workflow_dispatch:
    inputs:
      versionString:
        required: true
        type: string
        description: 'Package version string to use for the package. Should be in PEP 440 format.'

permissions:
  id-token: write
  contents: write
  checks: write

jobs:
  package-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Init and prints
        id: init
        run: |
          set -xe
          echo "Branch Name: ${GITHUB_REF#refs/heads/}" | tee -a $GITHUB_STEP_SUMMARY
          echo "Commit Hash: $(git rev-parse --short HEAD)" | tee -a $GITHUB_STEP_SUMMARY
          # Workaround for Generate build number cant handle + in version string
          echo "buildNumberString=$(echo ${{ github.event.inputs.versionString }} | sed 's/+/_/g')" >> $GITHUB_OUTPUT

      - name: Generate build number
        id: buildnumber
        uses: qm-labs/sw_release/.github/actions/build-tag-number@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          prefix: ${{ steps.init.outputs.buildNumberString }}

      - name: Set version
        run: |
          set -xe
          VERSION=${{ github.event.inputs.versionString }}${{ env.BUILD_NUMBER}}
          if [[ "$VERSION" =~ ^([0-9]+\.[0-9]+\.[0-9]+)([a-zA-Z0-9.-]*)$ ]]; then
            echo "BASE_VERSION=${BASH_REMATCH[1]}" >> $GITHUB_ENV
            echo "VERSION_SUFFIX=${BASH_REMATCH[2]}" >> $GITHUB_ENV
          else
            echo "BASE_VERSION=$VERSION" >> $GITHUB_ENV
            echo "VERSION_SUFFIX=" >> $GITHUB_ENV
          fi
          echo "FULL_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Setup Poetry
        run: |
          set -xe
          python -m pip install --upgrade pip
          python -m pip install --upgrade virtualenv
          pip install poetry==2.1.3
          pip install poetry-dynamic-versioning

      - name: Configure internal PyPI
        uses: qm-labs/actions-python/configure-internal-pypi@v1
        with:
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}

      - name: Poetry install
        run: poetry install

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: src/frontend/package-lock.json

      - name: Install frontend dependencies
        run: cd src/frontend && npm ci

      - name: Build frontend
        run: cd src/frontend && npm run build

      - name: Copy static files to package
        run: |
          mkdir -p src/qualibrate/app/qualibrate_static
          cp -r src/frontend/dist/* src/qualibrate/app/qualibrate_static/

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.CI_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.CI_AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Fetch CodeArtifact metadata
        id: code-artifact-metadata
        shell: bash
        run: |
          set -xe
          echo "code-artifact-token=$(aws codeartifact get-authorization-token --domain quantum-machines --domain-owner 439440158105 --query authorizationToken --output text)" >> $GITHUB_OUTPUT
          echo "code-artifact-repo-url=$(aws codeartifact get-repository-endpoint --domain quantum-machines --domain-owner 439440158105 --repository qm-pypi --format pypi --query repositoryEndpoint --output text)" >> $GITHUB_OUTPUT

      - name: Update package version
        run: |
          set -xe
          # Update pyproject.toml with the version
          sed -i "s/^version = .*/version = \"${{ env.FULL_VERSION }}\"/" pyproject.toml
          poetry version | sed 's/qualibrate/Version:/g' | tee -a $GITHUB_STEP_SUMMARY

      - name: Build and publish to private PyPI
        run: |
          set -xe
          poetry config repositories.qm-repo ${{ steps.code-artifact-metadata.outputs.code-artifact-repo-url }}
          poetry config http-basic.qm-repo "aws" ${{ steps.code-artifact-metadata.outputs.code-artifact-token }}
          poetry build
          poetry publish -r qm-repo

      - name: Create and push tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git tag -a "iv${{ env.FULL_VERSION }}" -m "Internal release ${{ env.FULL_VERSION }}"
          git push origin "iv${{ env.FULL_VERSION }}"

      - name: Send slack message
        uses: qm-labs/actions-send-slack-message@v1
        if: success()
        with:
          channelId: "C05HJSFPWBC"
          message: "New internal version of qualibrate has been published to private PyPI. Version: ${{ env.FULL_VERSION }}"
          token: "${{ secrets.SLACK_BOT_TOKEN }}"